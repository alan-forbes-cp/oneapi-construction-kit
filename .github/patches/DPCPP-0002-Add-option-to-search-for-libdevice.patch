From 1e30134f8b1e3559394b65c3f62a44187dd8f259 Mon Sep 17 00:00:00 2001
From: PietroGhg <pietro.ghiglio@codeplay.com>
Date: Fri, 19 Jul 2024 14:06:01 +0100
Subject: [PATCH] Add option to search for libdevice

---
 clang/include/clang/Driver/Options.td |  2 ++
 clang/lib/Driver/Driver.cpp           | 12 ++++++++++--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/clang/include/clang/Driver/Options.td b/clang/include/clang/Driver/Options.td
index d08af9e0a58a..7f2fe1cd0c80 100644
--- a/clang/include/clang/Driver/Options.td
+++ b/clang/include/clang/Driver/Options.td
@@ -6937,6 +6937,8 @@ def fsycl_help_EQ : Joined<["-"], "fsycl-help=">, Flags<[NoXarchOption]>,
 def fsycl_help : Flag<["-"], "fsycl-help">, Alias<fsycl_help_EQ>,
   Flags<[NoXarchOption]>, AliasArgs<["all"]>,
   HelpText<"Emit help information from all of the offline compilation tools">;
+def fsycl_libdevice_path_EQ : Joined<["-"], "fsycl-libdevice-path=">,
+  Visibility<[ClangOption, CLOption, DXCOption, CC1Option]>, HelpText<"Path to libdevice library">;
 def fsycl_libspirv_path_EQ : Joined<["-"], "fsycl-libspirv-path=">,
   HelpText<"Path to libspirv library">;
 def fno_sycl_libspirv : Flag<["-"], "fno-sycl-libspirv">,
diff --git a/clang/lib/Driver/Driver.cpp b/clang/lib/Driver/Driver.cpp
index c3d3d93fd236..a43ac446037d 100644
--- a/clang/lib/Driver/Driver.cpp
+++ b/clang/lib/Driver/Driver.cpp
@@ -5564,7 +5564,7 @@ class OffloadingActionBuilder final {
           SYCLDeviceLibLinked = addSYCLDeviceLibs(
               TC, SYCLDeviceLibs, UseAOTLink,
               C.getDefaultToolChain().getTriple().isWindowsMSVCEnvironment(),
-              IsSYCLNativeCPU, NativeCPULib, BoundArch);
+              IsSYCLNativeCPU, NativeCPULib, BoundArch, Args);
         }
         JobAction *LinkSYCLLibs =
             C.MakeAction<LinkJobAction>(SYCLDeviceLibs, types::TY_LLVM_BC);
@@ -5842,9 +5842,17 @@ class OffloadingActionBuilder final {
 
     bool addSYCLDeviceLibs(const ToolChain *TC, ActionList &DeviceLinkObjects,
                            bool isSpirvAOT, bool isMSVCEnv, bool isNativeCPU,
-                           Action *&NativeCPULib, const char *BoundArch) {
+                           Action *&NativeCPULib, const char *BoundArch, DerivedArgList &Args) {
       int NumOfDeviceLibLinked = 0;
       SmallVector<SmallString<128>, 4> LibLocCandidates;
+      if(Args.hasArg(options::OPT_fsycl_libdevice_path_EQ)) {
+          auto ProvidedPath =
+              Args.getLastArgValue(options::OPT_fsycl_libdevice_path_EQ).str();
+          if (llvm::sys::fs::exists(ProvidedPath))  {
+            SmallString<128> ProvidedPathSS(ProvidedPath);
+            LibLocCandidates.push_back(ProvidedPathSS);
+          }
+      }
       SYCLInstallation.getSYCLDeviceLibPath(LibLocCandidates);
 
       SmallVector<std::string, 8> DeviceLibraries;
-- 
2.34.1

