name: ComputeAorta/ci-github-mrexport
on:
  workflow_dispatch:
  pull_request:
    paths:
    - source/**
    - clik/**
    - modules/**
    - examples/**
    - cmake/**
    - hal/**
    - .github/actions/do_build_ock/**
    - .github/actions/setup_ubuntu_build/**
    - .github/workflows/run_pr_tests.yml
    - CMakeLists.txt
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:

############### JOB   mr-ubuntu-gcc-x86_64-riscv-fp16-cl3-0-unitcl_vecz:

  mr-ubuntu-gcc-x86_64-riscv-fp16-cl3-0-unitcl_vecz:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      LLVM_LATEST: release_180
      LLVM_PREVIOUS: release_170
      Arch: x86_64
      Images: OFF
      CommandBuffer: ON
      USM: ON
      FP16: OFF
      Compiler: gcc-9
      LLVM_VERSION: $LLVM_LATEST
      EXTERNAL_MUX_COMPILER_DIRS: ${{ github.workspace }}/code/examples/refsi/refsi_m1/compiler/refsi_m1
      MUX_COMPILERS_TO_ENABLE: riscv
      HAL_DESCRIPTION: RV64GCV_Zfh
      HAL_REFSI_SOC: G1
      HAL_REFSI_THREAD_MODE: WG
      TARGET: check-ock-UnitCL-group-vecz
      DISABLE_VECZ_CHECKS: OFF
      CXXCompiler: $GITHUB_WORKSPACE/llvm_install/bin/clang++
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4.1.0
      with:
        path: code
    - run: cp -R code/.github .github
    - name: setup-ubuntu
      uses: ./.github/actions/setup_ubuntu_build
      with:
        llvm_version: '18'
        llvm_build_type: RelAssert
    - run: echo WORKSPACE is $GITHUB_WORKSPACE && echo PWD is `pwd` && ls -al
    - name: build ock
      uses: ./.github/actions/do_build_ock
      with:
        path: $GITHUB_WORKSPACE/code
        install_dir: $GITHUB_WORKSPACE/install
        llvm_install_dir: $GITHUB_WORKSPACE/llvm_install
        build_type: ReleaseAssert
        build_targets: $TARGET
        host_image: OFF
        enable_api: cl
        mux_targets_enable: riscv
        external_compiler_dirs: $EXTERNAL_MUX_COMPILER_DIRS
        mux_compilers_enable: $MUX_COMPILERS_TO_ENABLE
        riscv_enabled: ON
        disable_unitcl_vecz_checks: $DISABLE_VECZ_CHECKS
        enable_rvv_scalable_vecz_check: ON
        enable_rvv_scalable_vp_vecz_check: ON
        command_buffer: ON
        use_linker: gold
        hal_description: $HAL_DESCRIPTION
        hal_refsi_soc: $HAL_REFSI_SOC
        hal_refsi_thread_mode: $HAL_REFSI_THREAD_MODE
        build_dir: $GITHUB_WORKSPACE/build
        debug_support: ON

############### JOB   mr-ubuntu-gcc-x86_64-riscv-fp16-cl3-0:

  mr-ubuntu-gcc-x86_64-riscv-fp16-cl3-0:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      LLVM_LATEST: release_180
      LLVM_PREVIOUS: release_170
      Arch: x86_64
      Images: OFF
      CommandBuffer: ON
      USM: ON
      FP16: OFF
      Compiler: gcc-9
      LLVM_VERSION: $LLVM_LATEST
      EXTERNAL_MUX_COMPILER_DIRS: ${{ github.workspace }}/code/examples/refsi/refsi_m1/compiler/refsi_m1
      MUX_COMPILERS_TO_ENABLE: riscv
      HAL_DESCRIPTION: RV64GCV_Zfh
      HAL_REFSI_SOC: G1
      HAL_REFSI_THREAD_MODE: WG
      TARGET: check-ock
      DISABLE_VECZ_CHECKS: ON
      CXXCompiler: $GITHUB_WORKSPACE/llvm_install/bin/clang++
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4.1.0
      with:
        path: code
    - run: cp -R code/.github .github
    - name: setup-ubuntu
      uses: ./.github/actions/setup_ubuntu_build
      with:
        llvm_version: '18'
        llvm_build_type: RelAssert
    - run: echo WORKSPACE is $GITHUB_WORKSPACE && echo PWD is `pwd` && ls -al
    - name: build ock
      uses: ./.github/actions/do_build_ock
      with:
        path: $GITHUB_WORKSPACE/code
        install_dir: $GITHUB_WORKSPACE/install
        llvm_install_dir: $GITHUB_WORKSPACE/llvm_install
        build_type: ReleaseAssert
        build_targets: $TARGET
        host_image: OFF
        enable_api: cl
        mux_targets_enable: riscv
        external_compiler_dirs: $EXTERNAL_MUX_COMPILER_DIRS
        mux_compilers_enable: $MUX_COMPILERS_TO_ENABLE
        riscv_enabled: ON
        disable_unitcl_vecz_checks: $DISABLE_VECZ_CHECKS
        enable_rvv_scalable_vecz_check: ON
        enable_rvv_scalable_vp_vecz_check: ON
        command_buffer: ON
        use_linker: gold
        hal_description: $HAL_DESCRIPTION
        hal_refsi_soc: $HAL_REFSI_SOC
        hal_refsi_thread_mode: $HAL_REFSI_THREAD_MODE
        build_dir: $GITHUB_WORKSPACE/build
        debug_support: ON

############### JOB   mr-ubuntu-gcc-x86_64-cpu:

  mr-ubuntu-gcc-x86_64-cpu:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      LLVM_LATEST: release_180
      LLVM_PREVIOUS: release_170
      Arch: x86_64
      Images: OFF
      CommandBuffer: ON
      USM: ON
      FP16: OFF
      Compiler: gcc-9
      TARGET: check-ock-UnitCL
      ONEAPI_CON_KIT_DIR: ${{ github.workspace }}/code
      LLVM_VERSION: $LLVM_LATEST
      CXXCompiler: $GITHUB_WORKSPACE/llvm_install/bin/clang++
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4.1.0
      with:
        path: code
    - run: cp -R code/.github .github
    - name: setup-ubuntu
      uses: ./.github/actions/setup_ubuntu_build
      with:
        llvm_version: '18'
        llvm_build_type: RelAssert
    - run: echo WORKSPACE is $GITHUB_WORKSPACE && echo PWD is `pwd` && ls -al
    - run: pip install cookiecutter
    - run: python -u code/scripts/create_target.py $PWD/code $PWD/code/scripts/new_target_templates/cpu_x86.json --external-dir $GITHUB_WORKSPACE/cpu_hal_ock
    - run: ls -l $GITHUB_WORKSPACE/cpu_hal_ock
    - name: build ock
      uses: ./.github/actions/do_build_ock
      with:
        path: $GITHUB_WORKSPACE/cpu_hal_ock
        install_dir: $GITHUB_WORKSPACE/install
        llvm_install_dir: $GITHUB_WORKSPACE/llvm_install
        build_type: ReleaseAssert
        build_targets: $TARGET
        host_image: OFF
        enable_api: cl
        mux_targets_enable: cpu
        use_linker: gold
        offline_kernel_tests: ON
        oneapi_con_kit_dir: $ONEAPI_CON_KIT_DIR
        build_dir: $GITHUB_WORKSPACE/build
        debug_support: ON
        extra_flags: -DCA_EXTERNAL_CPU_HAL_DIR=$ONEAPI_CON_KIT_DIR/clik/external/hal_cpu -DCA_CPU_ENABLED=ON

############### JOB   mr-ubuntu-gcc-x86-llvm-previous-cl3-0-release:

  mr-ubuntu-gcc-x86-llvm-previous-cl3-0-release:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      LLVM_LATEST: release_180
      LLVM_PREVIOUS: release_170
      LLVM_VERSION: $LLVM_PREVIOUS
      Arch: x86
      TARGET: check-ock
      Images: OFF
      CommandBuffer: ON
      USM: ON
      FP16: OFF
      Compiler: gcc
      CXXCompiler: g++
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4.1.0
      with:
        path: code
    - run: cp -R code/.github .github
    - name: setup-ubuntu
      uses: ./.github/actions/setup_ubuntu_build
      with:
        llvm_version: '17'
        llvm_build_type: Release
        arch: x86
    - run: echo WORKSPACE is $GITHUB_WORKSPACE && echo PWD is `pwd` && ls -al
    - name: build ock
      uses: ./.github/actions/do_build_ock
      with:
        path: $GITHUB_WORKSPACE/code
        install_dir: $GITHUB_WORKSPACE/install
        llvm_install_dir: $GITHUB_WORKSPACE/llvm_install
        build_type: Release
        arch: $Arch
        build_targets: $TARGET
        host_image: $Images
        debug_support: ON
        host_enable_builtins: ON
        host_fp16: $FP16
        assemble_spirv_ll_lit_test_offline: OFF
        usm: $USM
        command_buffer: $CommandBuffer
        use_linker: gold
        build_dir: $GITHUB_WORKSPACE/build
        extra_flags: -DCMAKE_C_COMPILER=$Compiler -DCMAKE_CXX_COMPILER=$CXXCompiler

############### JOB   mr-ubuntu-clang-x86-llvm-latest-cl3-0:

  mr-ubuntu-clang-x86-llvm-latest-cl3-0:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    env:
      LLVM_LATEST: release_180
      LLVM_PREVIOUS: release_170
      Arch: x86
      TARGET: check-ock
      Images: OFF
      CommandBuffer: ON
      USM: ON
      FP16: OFF
      Compiler: $GITHUB_WORKSPACE/llvm_install/bin/clang
      CXXCompiler: $GITHUB_WORKSPACE/llvm_install/bin/clang++
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4.1.0
      with:
        path: code
    - run: cp -R code/.github .github
    - name: setup-ubuntu
      uses: ./.github/actions/setup_ubuntu_build
      with:
        llvm_version: '18'
        llvm_build_type: RelAssert
        arch: x86
    - run: echo WORKSPACE is $GITHUB_WORKSPACE && echo PWD is `pwd` && ls -al
    - run: ls -alR $GITHUB_WORKSPACE/llvm_install
    - name: build ock
      uses: ./.github/actions/do_build_ock
      with:
        path: $GITHUB_WORKSPACE/code
        install_dir: $GITHUB_WORKSPACE/install
        llvm_install_dir: $GITHUB_WORKSPACE/llvm_install
        build_type: ReleaseAssert
        arch: $Arch
        extra_flags: -DCMAKE_C_COMPILER=$Compiler -DCMAKE_CXX_COMPILER=$CXXCompiler
        build_targets: $TARGET
        host_image: $Images
        host_enable_builtins: ON
        host_fp16: $FP16
        assemble_spirv_ll_lit_test_offline: OFF
        usm: $USM
        command_buffer: $CommandBuffer
        use_linker: gold
        build_dir: $GITHUB_WORKSPACE/build
        debug_support: ON
