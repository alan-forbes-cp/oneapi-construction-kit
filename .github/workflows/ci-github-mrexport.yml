name: ComputeAorta/ci-github-mrexport
on:
  push:
# main only?
#    branches:
#      - main
  workflow_dispatch:
concurrency:
  group: "${{ github.ref }}"
  cancel-in-progress: true
#env:
  #  All imported env: settings at this levels are deleted
jobs:
  mr-ubuntu-clang-x86-llvm-previous-cl3-0-offline:
    runs-on: ubuntu-22.04
    if: ${{ github.event_name }} == "merge_request_event" && $RUN_BUILD_TEST == "1"
    timeout-minutes: 60
    env:
      RUN_BUILD_TEST: '1'
      BuildType: ReleaseAssert
      Images: 'OFF'
      CommandBuffer: 'ON'
      USM: 'ON'
      FP16: 'OFF'
      Compiler: llvm_install/bin/clang
      # CXXCompiler is new
      CXXCompiler: llvm_install/bin/clang++
    steps:
    # checkout to code directory
    - name: Checkout repo
      uses: actions/checkout@v4.1.0
      with:
        path: code
    # copy .github to workspace top level
    - run: cp -R code/.github .github
    - name: setup-ubuntu
      # installs tools, ninja, installs llvm and sets up sccache
      uses:  ./.github/actions/setup_ubuntu_build
      with:
        llvm_version: 17
        llvm_build_type: RelAssert
#    - run: wget -qO - https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
#    - run: sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-1.3.243-jammy.list https://packages.lunarg.com/vulkan/1.3.243/lunarg-vulkan-1.3.243-jammy.list
#    - run: sudo apt-get update
#    - run: sudo apt-get install --yes vulkan-sdk

    - run: echo python -u scripts/build.py -GNinja --verbose --clean --build_type $BuildType --arch $Arch --compiler $Compiler --artefact_name $LLVMBranch --target $Target -DCA_CL_ENABLE_ICD_LOADER=ON -DCA_ENABLE_HOST_IMAGE_SUPPORT=$Images -DCA_HOST_ENABLE_BUILTIN_KERNEL=ON -DCA_HOST_ENABLE_BUILTINS_EXTENSION=ON -DCA_HOST_ENABLE_FP16=$FP16 -DCA_ASSEMBLE_SPIRV_LL_LIT_TESTS_OFFLINE=OFF -DOCL_EXTENSION_cl_intel_unified_shared_memory=$USM -DOCL_EXTENSION_cl_khr_command_buffer=$CommandBuffer -DOCL_EXTENSION_cl_khr_command_buffer_mutable_dispatch=$CommandBuffer -DCA_USE_LINKER=gold

    - run: echo cmake -GNinja -DCA_CL_ENABLE_ICD_LOADER=ON -DCA_ENABLE_HOST_IMAGE_SUPPORT=OFF -DCA_HOST_ENABLE_BUILTIN_KERNEL=ON -DCA_HOST_ENABLE_BUILTINS_EXTENSION=ON -DCA_HOST_ENABLE_FP16=$FP16 -DCA_ASSEMBLE_SPIRV_LL_LIT_TESTS_OFFLINE=OFF -DOCL_EXTENSION_cl_intel_unified_shared_memory=ON -DOCL_EXTENSION_cl_khr_command_buffer=$CommandBuffer -DOCL_EXTENSION_cl_khr_command_buffer_mutable_dispatch=$CommandBuffer -DCA_USE_LINKER=gold -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/build/install -DCA_LLVM_INSTALL_DIR=$GITHUB_WORKSPACE/build/llvm -DCMAKE_BUILD_TYPE=$BuildType -DCMAKE_C_COMPILER=$GITHUB_WORKSPACE/$Compiler -DCMAKE_CXX_COMPILER=$GITHUB_WORKSPACE/$CXXCompiler -DCA_ENABLE_DEBUG_SUPPORT=ON -DCA_BUILTINS_TOOLS_DIR=$GITHUB_WORKSPACE/build/llvm/llvm_tools -DCA_BUILD_32_BITS=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache "-DCA_GTEST_LAUNCHER=/usr/bin/python;-u;scripts/gtest-terse-runner.py" $GITHUB_WORKSPACE
    - run: echo cmake -GNinja -DCA_CL_ENABLE_ICD_LOADER=ON -DCA_ENABLE_HOST_IMAGE_SUPPORT=OFF -DCA_HOST_ENABLE_BUILTIN_KERNEL=ON -DCA_HOST_ENABLE_BUILTINS_EXTENSION=ON -DCA_HOST_ENABLE_FP16=$FP16 -DCA_ASSEMBLE_SPIRV_LL_LIT_TESTS_OFFLINE=OFF -DOCL_EXTENSION_cl_intel_unified_shared_memory=ON -DOCL_EXTENSION_cl_khr_command_buffer=$CommandBuffer -DOCL_EXTENSION_cl_khr_command_buffer_mutable_dispatch=$CommandBuffer -DCA_USE_LINKER=gold -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/build/install -DCA_LLVM_INSTALL_DIR=$GITHUB_WORKSPACE/llvm_install -DCMAKE_BUILD_TYPE=$BuildType -DCMAKE_C_COMPILER=$GITHUB_WORKSPACE/$Compiler -DCMAKE_CXX_COMPILER=$GITHUB_WORKSPACE/$CXXCompiler -DCA_ENABLE_DEBUG_SUPPORT=ON -DCA_BUILTINS_TOOLS_DIR=$GITHUB_WORKSPACE/build/llvm/llvm_tools -DCA_BUILD_32_BITS=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache "-DCA_GTEST_LAUNCHER=/usr/bin/python;-u;scripts/gtest-terse-runner.py" $GITHUB_WORKSPACE/code
    - run: pwd && ls -al
    - name: build ock
      uses: ./.github/actions/do_build_ock
      with:
        path: $GITHUB_WORKSPACE/code
#        assemble_spirv_ll_lit_test_offline:
        build_dir: $GITHUB_WORKSPACE/build
        #build_targets: check-ock
        build_targets: check-ock-all-lit
        build_type: $BuildType
        c_compiler: $Compiler
        cxx_compiler: $CXXCompiler
        command_buffer: $CommandBuffer
        debug_support: ON
#        enable_api:
#        enable_rvv_scalable_vecz_check:
#        enable_rvv_scalable_VP_vecz_check:
#        external_compiler_dirs:
#        extra_flags:
#        hal_description:
#        hal_refsi_soc:
        host_fp16: $FP16
        host_image: $Images
        host_enable_builtins: ON
        install_dir: $GITHUB_WORKSPACE/install
        llvm_install_dir: $GITHUB_WORKSPACE/llvm_install
#        mux_compilers_enable:
#        mux_targets_enable:
#        offline_kernel_tests:
#        riscv_enabled:
        usm: $USM
    - run: pwd && ls -al
    - run: ls -al *

#     # 'artifacts.junit' was not transformed because there is no suitable equivalent in GitHub Actions
